<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for myProcess\middlewares\auth.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">myProcess/middlewares/</a> auth.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">84% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>21/25</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">60% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>6/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>1/1</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.24% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>20/21</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var cacheUser = require('../libs/cache-user.js');
var commonError = require('../libs/error.js');
//var User = require('../models/sys/user.js');
var util = require('util');
var extend = util._extend;
const crypto = require('crypto');
var config = require('../config.js');
&nbsp;
//var retrieveUserCtrlRights = function *(ctx, modulepath){
//    // 获取用户token
//    var token  = ctx.cookies.get('token') || ctx.headers['token'] || ctx.query.token;
//
//    // 用户没有上传token
//    if(!token) throw new commonError.TokenMissing();
//    // 解密token 得到用户账号
//    var decipher = crypto.createDecipher('rc4', config.tokenSecretKey);
//    token = decipher.update(token, 'hex', 'utf8');
//    token += decipher.final('utf8');
//
//    var account = token;
//    var userKey = 'user-' + account; // user-codisan, 用户在redis中的key
//
//    // 检查该用户是否登录
//    var isLogin = yield* cacheUser.isLogin(userKey); // 0/1
//    var keys = ['id', 'account', 'name'];
//
//    var userCtrlRights;       // 该用户，对应请求的模块，的权限：read,update,destroy...
//
//    // 提取用户相关信息
//    if(isLogin){
//        // 从redis中 取出用户信息，存放到 ctx.state.user 中, keys: (id, name, deptId, orgId)
//        var vals = yield* cacheUser.props(userKey, keys);
//
//        keys.forEach(function(k, i){
//            ctx.state.user[k] = vals[i];
//        });
//
//        // 取出该模块对应的权限, sys/user: read,create,update
//        userCtrlRights = yield* cacheUser.prop(userKey, modulepath);
//    }else{
//        // 从数据库获取用户信息，存放到redis，和 ctx.state.user 中
//        var dbUser = yield User.findOne({account: account}).exec();
//        ctx.state.user.id = dbUser._id;
//        ctx.state.user.account = dbUser.account;
//        ctx.state.user.name = dbUser.name;
//        // 从数据库获取该用户的模块权限
//        var right = yield* User.rights(account);
//
//        // 将用户信息，和模块权限，一并存储到 redis 中
//        var userInfo = Object.assign({}, ctx.state.user, right);
//        yield* cacheUser.hmset(userKey, userInfo);
//        // 取出该模块对应的权限
//        userCtrlRights = right[modulepath];
//    }
//
//    return userCtrlRights;
//};
&nbsp;
module.exports = function* (next){
    var controllers = this.app.controllers;
    // 所有的服务器端请求，都已 /api 开始, 后面接上 module + controller + action
    // Eg: /api/sys/user/read
    var ctx = this;
    ctx.state.user = {};        // 存放用户信息
&nbsp;
    var urlreg = /api\/(\w*\/\w*)\/(\w*)/;
&nbsp;
    // 如果请求不合法则抛出异常
    <span class="missing-if-branch" title="if path not taken" >I</span>if(!urlreg.test(ctx.path)) <span class="cstat-no" title="statement not covered" >throw new commonError.RequestUrlNotMatch();</span>
&nbsp;
    var match = urlreg.exec(ctx.path), // ["api/sys/user/read", "sys/user", "read"]
        modulepath = match[1],         // sys/user
        action = match[2],             // read
        method = ctx.method.toLowerCase(); // get,post
&nbsp;
    // 提取访问的模块，如果模块不存在，则抛出异常
    <span class="missing-if-branch" title="if path not taken" >I</span>if(!controllers[modulepath]) <span class="cstat-no" title="statement not covered" >throw new commonError.ControllerNotFound();</span>
&nbsp;
    // 提取要访问的Action, 如果 Action 不存在，则抛出异常
    var actions = controllers[modulepath];
    var serverAction = actions.find(a =&gt; a.code == action &amp;&amp; a.method == method);
    <span class="missing-if-branch" title="if path not taken" >I</span>if(!serverAction) <span class="cstat-no" title="statement not covered" >throw new commonError.ActionNotFound();</span>
&nbsp;
    var err = serverAction.validate(ctx.query, ctx.request.body);
    <span class="missing-if-branch" title="if path not taken" >I</span>if(err){
<span class="cstat-no" title="statement not covered" >        throw new commonError.ParameterError(null, null, err);</span>
    }
&nbsp;
&nbsp;
    return yield* serverAction.handler.call(this, ctx, ctx.request, ctx.response);
&nbsp;
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Oct 12 2016 15:29:42 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
